name: Invalidations
on: [push]

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
    - uses: julia-actions/setup-julia@v1
      with:
        version: 'nightly'
        
    - uses: actions/checkout@v2
    - uses: julia-actions/julia-buildpkg@latest
    - uses: julia-actions/julia-invalidations@v1
      id: invs_pr
    
    - uses: actions/checkout@v2
      with:
        ref: 'master'
    - uses: julia-actions/julia-buildpkg@latest
    - uses: julia-actions/julia-invalidations@v1
      id: invs_master
    
    - name: Print invalidation report
      id: report
      run: |
        echo "Invalidations on master: ${{ steps.invs_master.outputs.total }} (${{ steps.invs_master.outputs.deps }} via deps)"
        echo "This branch: ${{ steps.invs_pr.outputs.total }} (${{ steps.invs_pr.outputs.deps }} via deps)"
      shell: bash  
      
    - name: Report invalidations as check 
      uses: dflydev/check-runs-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        output: '{"summary":Invalidations on master: ${{ steps.invs_master.outputs.total }} (${{ steps.invs_master.outputs.deps }} via deps)\nThis branch: ${{ steps.invs_pr.outputs.total }} (${{ steps.invs_pr.outputs.deps }} via deps)"}'
        id: Invalidations
        name: "${{ steps.invs_pr.outputs.total }} (${{ steps.invs_master.outputs.deps }} via deps) vs. ${{ steps.invs_master.outputs.total }} on master"
        conclusion: ${{ steps.invs_pr.outputs.total > steps.invs_master.outputs.total }} ? "failure" : "success"
